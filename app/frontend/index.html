<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Genomic Annotation Version Controllers — Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .panel { border: 1px solid #ddd; padding: 12px; margin-bottom: 12px; border-radius: 6px; }
    pre { background: #f6f8fa; padding: 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Genomic Annotation Version Controllers — Demo</h1>

  <div class="panel">
    <h3>Single liftover</h3>
    <label>Chromosome: <input id="single-chrom" value="chr1"></label>
    <label>Pos: <input id="single-pos" value="100000" type="number"></label>
    <label>From: <input id="single-from" value="hg19"></label>
    <label>To: <input id="single-to" value="hg38"></label>
    <label>Fallback UCSC: <input id="single-fallback" type="checkbox"></label>
    <button id="run-single">Run</button>
    <div id="single-result"></div>
  </div>

  <div class="panel">
    <h3>Batch liftover (CSV/TSV)</h3>
    <input type="file" id="batch-file" accept=".csv,.tsv,.txt" />
    <label>From: <input id="batch-from" value="hg19"></label>
    <label>To: <input id="batch-to" value="hg38"></label>
    <label>Fallback UCSC: <input id="batch-fallback" type="checkbox"></label>
    <button id="run-batch">Upload & Run</button>
    <div id="batch-results"></div>
  </div>

  <div class="panel">
    <h3>Conflict resolution demo</h3>
    <textarea id="example-annotations" rows="6" style="width:100%;">[
  {"source": "db1", "value": "geneA", "evidence_score": 2.0, "description": "Annotated as geneA (high confidence) by db1"},
  {"source": "db2", "value": "geneA", "evidence_score": 1.0, "description": "Gene called geneA by db2 mapping"},
  {"source": "predictorX", "value": "geneB", "evidence_score": 0.5, "description": "Predicted as geneB; low confidence"}
]</textarea>
    <div>
      <button id="run-conflict">Deterministic resolve</button>
      <button id="run-ai">AI semantic resolve</button>
    </div>
    <div id="conflict-result"></div>
  </div>

  <div class="panel">
    <h3>Embeddings / Vector demo (ingest/search)</h3>
    <textarea id="ingest-text" rows="4" style="width:100%;">[{"id":"sample1","description":"sample annotation text","source":"demo"}]</textarea>
    <div>
      <label>Version: <input id="ingest-version" value="demo"></label>
      <label>Model: <input id="ingest-model" value="sbert"></label>
      <label>Seq type: 
        <select id="ingest-seqtype"><option value="text">text</option><option value="protein">protein</option><option value="dna">dna</option></select>
      </label>
      <button id="run-ingest">Ingest</button>
    </div>
    <div>
      <input id="search-query" placeholder="search text or sequence" style="width:60%">
      <button id="run-search">Search</button>
    </div>
    <div id="embed-results"></div>
  </div>

<script>
// Replace the existing run-ai handler with the code below
function fmtPercent(raw) {
  if (raw === null || raw === undefined) return "n/a";
  let v = Number(raw);
  if (Number.isNaN(v)) return "n/a";
  // If the server returned e.g. a raw cosine in [-1,1], map to [0,1]
  if (v < -1 || v > 1) {
    // if it's >1 and looks like a percent (e.g., 3232397), assume it was an erroneous percent and interpret conservatively
    // but clamp to 1.0 max
    v = Math.min(Math.max(v, 0.0), 1.0);
  } else if (v >= -1 && v <= 1) {
    // likely a fraction or cosine; if in [-1,1], assume fraction/cosine: map to [0,1] where appropriate
    // if value is non-negative assume it's already a fraction; if negative treat as 0 fraction
    if (v < 0) v = 0;
    // if value is in [0,1], keep as fraction
  }
  // Convert fraction to percent and clamp
  let pct = Math.round(Math.min(Math.max(v, 0.0), 1.0) * 10000) / 100; // 2 decimal places
  return pct.toFixed(2) + "%";
}

document.getElementById('run-ai').addEventListener('click', async () => {
  let anns;
  try {
    anns = JSON.parse(document.getElementById('ai-annotations').value);
  } catch (e) {
    alert('Invalid annotations JSON');
    return;
  }
  const model = document.getElementById('ai-model').value;
  const sim_threshold = parseFloat(document.getElementById('ai-threshold').value);
  const prefer_sbert = document.getElementById('ai-prefer-sbert').checked;
  document.getElementById('ai-result').innerText = 'Running (this may take a few seconds while model loads)...';
  const payload = {annotations: anns, model: model, sim_threshold: sim_threshold, prefer_sbert: prefer_sbert};
  const res = await fetch('/api/conflict/ai_resolve', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
  const data = await res.json();
  // pretty print clusters and formatted confidences
  if (data && data.clusters) {
    let out = { num_clusters: data.num_clusters, global_entropy: data.global_entropy, consensus: [] };
    for (const c of data.consensus || []) {
      out.consensus.push({
        consensus_value: c.consensus_value,
        combined_confidence: fmtPercent(c.combined_confidence),
        cluster_id: c.cluster_id,
        cluster_size: c.cluster_size,
        top_sources: c.top_sources
      });
    }
    document.getElementById('ai-result').innerHTML = `<pre>${JSON.stringify(out, null, 2)}</pre>`;
  } else {
    document.getElementById('ai-result').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
  }
});
</script>